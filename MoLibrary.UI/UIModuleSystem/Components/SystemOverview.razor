@using MoLibrary.Core.Module.Dashboard.Models
@using MoLibrary.Core.Module.Models
@using MudBlazor

<div class="system-overview-container">
    @if (SystemStatus != null)
    {
        <MudGrid Spacing="4" Class="mb-4">
            <!-- 系统状态概览 -->
            <MudItem xs="12" sm="6" md="3">
                <MudCard Class="status-card modern-card">
                    <MudCardContent Class="pa-4">
                        <div class="card-header d-flex align-center mb-4">
                            <MudIcon Icon="@GetStatusIcon(SystemStatus.State)" 
                                   Color="@GetStatusColor(SystemStatus.State)" 
                                   Size="Size.Large" 
                                   Class="mr-3" />
                            <MudText Typo="Typo.h6">系统状态</MudText>
                        </div>
                        <div class="card-content">
                            <MudText Typo="Typo.h4" Class="mb-3" Color="@GetStatusColor(SystemStatus.State)">
                                @GetStatusText(SystemStatus.State)
                            </MudText>
                            <MudProgressLinear Color="@GetStatusColor(SystemStatus.State)" 
                                             Value="@(SystemStatus.IsInitialized ? 100 : 0)" 
                                             Class="mb-2" 
                                             Size="Size.Medium" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(SystemStatus.IsInitialized ? "系统已完成初始化" : "系统正在初始化...")
                            </MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 模块统计 -->
            <MudItem xs="12" sm="6" md="3">
                <MudCard Class="stats-card modern-card">
                    <MudCardContent Class="pa-4">
                        <div class="card-header d-flex align-center mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Apps" 
                                   Color="Color.Primary" 
                                   Size="Size.Large" 
                                   Class="mr-3" />
                            <MudText Typo="Typo.h6">模块统计</MudText>
                        </div>
                        <div class="card-content">
                            <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-3">
                                @SystemStatus.TotalModules
                            </MudText>
                            <MudStack Row="true" Spacing="1" Class="mb-2">
                                <MudChip T="string" Size="Size.Small" Color="Color.Success">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                    @SystemStatus.EnabledModules
                                </MudChip>
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Class="mr-1" />
                                    @SystemStatus.DisabledModules
                                </MudChip>
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                总模块数量
                            </MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 初始化时间 -->
            <MudItem xs="12" sm="6" md="3">
                <MudCard Class="performance-card modern-card">
                    <MudCardContent Class="pa-4">
                        <div class="card-header d-flex align-center mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Timer" 
                                   Color="Color.Warning" 
                                   Size="Size.Large" 
                                   Class="mr-3" />
                            <MudText Typo="Typo.h6">初始化时间</MudText>
                        </div>
                        <div class="card-content">
                            <MudText Typo="Typo.h4" Color="Color.Warning" Class="mb-3">
                                @(SystemStatus.TotalInitializationTimeMs)ms
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                启动时间: @(SystemStatus.StartTime?.ToString("HH:mm:ss") ?? "未知")
                            </MudText>
                            <MudProgressLinear Color="Color.Warning" 
                                             Value="@GetInitTimeProgress(SystemStatus.TotalInitializationTimeMs)" 
                                             Class="mb-2"
                                             Size="Size.Medium" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @GetInitTimeDescription(SystemStatus.TotalInitializationTimeMs)
                            </MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 健康状态 -->
            <MudItem xs="12" sm="6" md="3">
                <MudCard Class="health-card modern-card">
                    <MudCardContent Class="pa-4">
                        <div class="card-header d-flex align-center mb-4">
                            <MudIcon Icon="@GetHealthIcon()" 
                                   Color="@GetHealthColor()" 
                                   Size="Size.Large" 
                                   Class="mr-3" />
                            <MudText Typo="Typo.h6">健康状态</MudText>
                        </div>
                        <div class="card-content">
                            <MudText Typo="Typo.h4" Color="@GetHealthColor()" Class="mb-3">
                                @GetHealthText()
                            </MudText>
                            <div class="mb-2">
                                @if (SystemStatus.HasRegistrationErrors || SystemStatus.HasCircularDependencies)
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                        存在问题
                                    </MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                        运行正常
                                    </MudChip>
                                }
                            </div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(SystemStatus.HasRegistrationErrors ? "检测到注册错误" : 
                                  SystemStatus.HasCircularDependencies ? "检测到循环依赖" : "系统健康运行")
                            </MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudGrid Spacing="4" Class="mb-4">
            @for (int i = 0; i < 4; i++)
            {
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Class="modern-card">
                        <MudCardContent Class="pa-4 d-flex align-center justify-center" Style="min-height: 200px;">
                            <div class="text-center">
                                <MudProgressCircular Indeterminate="true" Class="mb-3" />
                                <MudText Color="Color.Secondary">加载中...</MudText>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</div>

@code {
    /// <summary>
    /// 系统状态数据
    /// </summary>
    [Parameter] public ModuleSystemStatus? SystemStatus { get; set; }

    /// <summary>
    /// 获取状态图标
    /// </summary>
    /// <param name="state">系统状态</param>
    /// <returns>图标名称</returns>
    private string GetStatusIcon(ModuleSystemState state) => state switch
    {
        ModuleSystemState.NotInitialized => Icons.Material.Filled.HourglassEmpty,
        ModuleSystemState.Initializing => Icons.Material.Filled.HourglassFull,
        ModuleSystemState.Initialized => Icons.Material.Filled.CheckCircle,
        ModuleSystemState.Failed => Icons.Material.Filled.Error,
        _ => Icons.Material.Filled.HelpOutline
    };

    /// <summary>
    /// 获取状态颜色
    /// </summary>
    /// <param name="state">系统状态</param>
    /// <returns>颜色</returns>
    private Color GetStatusColor(ModuleSystemState state) => state switch
    {
        ModuleSystemState.NotInitialized => Color.Dark,
        ModuleSystemState.Initializing => Color.Warning,
        ModuleSystemState.Initialized => Color.Success,
        ModuleSystemState.Failed => Color.Error,
        _ => Color.Default
    };

    /// <summary>
    /// 获取状态文本
    /// </summary>
    /// <param name="state">系统状态</param>
    /// <returns>状态文本</returns>
    private string GetStatusText(ModuleSystemState state) => state switch
    {
        ModuleSystemState.NotInitialized => "未初始化",
        ModuleSystemState.Initializing => "初始化中",
        ModuleSystemState.Initialized => "已初始化",
        ModuleSystemState.Failed => "初始化失败",
        _ => "未知状态"
    };

    /// <summary>
    /// 获取健康状态图标
    /// </summary>
    /// <returns>图标名称</returns>
    private string GetHealthIcon() => SystemStatus?.HasRegistrationErrors == true || SystemStatus?.HasCircularDependencies == true
        ? Icons.Material.Filled.Error
        : Icons.Material.Filled.CheckCircle;

    /// <summary>
    /// 获取健康状态颜色
    /// </summary>
    /// <returns>颜色</returns>
    private Color GetHealthColor() => SystemStatus?.HasRegistrationErrors == true || SystemStatus?.HasCircularDependencies == true
        ? Color.Error
        : Color.Success;

    /// <summary>
    /// 获取健康状态文本
    /// </summary>
    /// <returns>健康状态文本</returns>
    private string GetHealthText() => SystemStatus?.HasRegistrationErrors == true || SystemStatus?.HasCircularDependencies == true
        ? "存在问题"
        : "健康";

    /// <summary>
    /// 获取初始化时间进度
    /// </summary>
    /// <param name="totalTimeMs">总初始化时间（毫秒）</param>
    /// <returns>进度值</returns>
    private double GetInitTimeProgress(long totalTimeMs)
    {
        if (totalTimeMs == 0) return 0;
        return SystemStatus?.IsInitialized == true ? 100 : (SystemStatus?.TotalInitializationTimeMs ?? 0) / totalTimeMs * 100;
    }

    /// <summary>
    /// 获取初始化时间描述
    /// </summary>
    /// <param name="totalTimeMs">总初始化时间（毫秒）</param>
    /// <returns>描述文本</returns>
    private string GetInitTimeDescription(long totalTimeMs)
    {
        if (totalTimeMs == 0) return "系统正在启动...";
        if (SystemStatus?.IsInitialized == true) return "系统已完成初始化";
        return $"系统已运行 {totalTimeMs}ms";
    }
} 