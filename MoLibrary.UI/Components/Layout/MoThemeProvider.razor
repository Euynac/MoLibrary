@using MoLibrary.UI.Services
@inject MoThemeService ThemeService
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudThemeProvider Theme="@ThemeService.CurrentTheme" IsDarkMode="@ThemeService.IsDarkMode" />

<div class="@ThemeService.GetThemeCssClass()">
    @ChildContent
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/theme-helper.js").ConfigureAwait(false);
                var prefersDark = await module.InvokeAsync<bool>("getThemePreference").ConfigureAwait(false);
                
                // Use InvokeAsync to ensure we're on the UI thread when setting the theme
                await InvokeAsync(() =>
                {
                    ThemeService.IsDarkMode = prefersDark;
                });
            }
            catch (Exception)
            {
                // 如果JavaScript模块加载失败，使用默认主题
                await InvokeAsync(() =>
                {
                    ThemeService.IsDarkMode = false;
                });
            }
        }
    }

    private async void OnThemeChanged()
    {
        try
        {
            // 保存主题偏好到localStorage
            var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/theme-helper.js").ConfigureAwait(false);
            await module.InvokeVoidAsync("saveThemePreference", ThemeService.IsDarkMode);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception)
        {
            // 如果JavaScript模块加载失败，回退到直接调用localStorage
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "mo-theme-preference", ThemeService.IsDarkMode ? "dark" : "light");
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}