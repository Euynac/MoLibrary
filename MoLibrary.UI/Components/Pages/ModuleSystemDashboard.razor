@attribute [Route(MODULE_SYSTEM_DASHBOARD_URL)]
@using MoLibrary.Core.Module.Dashboard.Interfaces
@using MoLibrary.Core.Module.Dashboard.Models
@using MoLibrary.Core.Module.Models
@using MoLibrary.UI.UIModuleSystem.Components
@inject IModuleSystemStatusService StatusService
@inject ISnackbar SnackBar

<PageTitle>模块系统仪表板</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="ma-4">
    <MudPaper Class="pa-6 mb-6" Elevation="2">
        <MudText Typo="Typo.h3" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="mr-3" />
            模块系统仪表板
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary">
            全面监控和管理系统模块状态、性能和依赖关系
        </MudText>
    </MudPaper>

    <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" Class="mb-6">
        <MudTabPanel Text="系统概览" Icon="@Icons.Material.Filled.Assessment">
            <MudPaper Class="pa-4 ma-2" Elevation="1">
                <SystemOverview SystemStatus="systemStatus" />
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="性能监控" Icon="@Icons.Material.Filled.Speed">
            <MudPaper Class="pa-4 ma-2" Elevation="1">
                <PerformanceMonitoring SystemPerformance="systemPerformance" />
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="健康检查" Icon="@Icons.Material.Filled.HealthAndSafety">
            <MudPaper Class="pa-4 ma-2" Elevation="1">
                <HealthCheck HealthCheckData="healthCheck" />
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="模块管理" Icon="@Icons.Material.Filled.ViewModule">
            <MudPaper Class="pa-4 ma-2" Elevation="1">
                <ModuleManagement RegistrationInfo="registrationInfo" 
                                OnRefresh="RefreshData" 
                                OnModuleDetailClicked="ViewModuleDetail" />
            </MudPaper>
        </MudTabPanel>

        <MudTabPanel Text="依赖关系" Icon="@Icons.Material.Filled.AccountTree">
            <MudPaper Class="pa-4 ma-2" Elevation="1">
                <DependencyGraph DependencyGraphData="dependencyGraph" />
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

<!-- 模块详情对话框 -->
<ModuleDetailDialog @bind-IsVisible="showModuleDetail" 
                   SelectedModuleDetail="selectedModuleDetail" />


@code {
    public const string MODULE_SYSTEM_DASHBOARD_URL = "/module-system-dashboard";
    private ModuleSystemStatus? systemStatus;
    private ModuleSystemPerformance? systemPerformance;
    private ModuleSystemHealthCheck? healthCheck;
    private ModuleRegistrationInfo? registrationInfo;
    private ModuleDependencyGraph? dependencyGraph;
    private ModuleDetailInfo? selectedModuleDetail;
    private bool showModuleDetail = false;

   

   
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshData();
        }
    }
    /// <summary>
    /// 刷新数据
    /// </summary>
    /// <returns></returns>
    private async Task RefreshData()
    {
        try
        {
            systemStatus = StatusService.GetSystemStatus();
            systemPerformance = StatusService.GetSystemPerformance();
            healthCheck = StatusService.GetHealthCheck();
            registrationInfo = StatusService.GetRegistrationInfo();
            dependencyGraph = StatusService.GetDependencyGraph();
            
            SnackBar.Add("数据已刷新", Severity.Success);
        }
        catch (Exception ex)
        {
            SnackBar.Add($"刷新数据失败: {ex.Message}", Severity.Error);
        }
    }

    /// <summary>
    /// 查看模块详情
    /// </summary>
    /// <param name="moduleEnum">模块枚举</param>
    /// <returns></returns>
    private async Task ViewModuleDetail(EMoModules moduleEnum)
    {
        try
        {
            selectedModuleDetail = StatusService.GetModuleDetail(moduleEnum);
            if (selectedModuleDetail != null)
            {
                showModuleDetail = true;
            }
            else
            {
                SnackBar.Add("模块详情不存在", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            SnackBar.Add($"获取模块详情失败: {ex.Message}", Severity.Error);
        }
    }
} 