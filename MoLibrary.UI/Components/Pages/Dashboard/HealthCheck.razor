@using MoLibrary.Core.Module.Dashboard.Models
@using MudBlazor

<div class="health-container">
    @if (HealthCheckData != null)
    {
        <MudGrid>
            <!-- 健康概览 -->
            <MudItem xs="12" md="4">
                <MudCard Class="health-overview-card">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">健康概览</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="health-status">
                            <MudIcon Icon="@GetHealthStatusIcon(HealthCheckData.OverallHealth)" 
                                   Color="@GetHealthStatusColor(HealthCheckData.OverallHealth)" 
                                   Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="ml-2">
                                @HealthCheckData.OverallHealth.ToString()
                            </MudText>
                        </div>
                        <MudText Typo="Typo.body2" Class="mt-2">
                            @HealthCheckData.HealthSummary
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                            检查时间: @HealthCheckData.CheckTime.ToString("yyyy-MM-dd HH:mm:ss")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 性能指标 -->
            <MudItem xs="12" md="8">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">性能指标</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.subtitle2">平均初始化时间</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Primary">
                                    @($"{HealthCheckData.PerformanceMetrics.AverageModuleInitTimeMs:F2}ms")
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.subtitle2">最慢模块时间</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Warning">
                                    @($"{HealthCheckData.PerformanceMetrics.SlowestModuleInitTimeMs}ms")
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.subtitle2">效率评分</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Success">
                                    @($"{HealthCheckData.PerformanceMetrics.InitializationEfficiencyScore}/100")
                                </MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.subtitle2">内存使用</MudText>
                                <MudText Typo="Typo.h6" Color="Color.Info">
                                    @(HealthCheckData.PerformanceMetrics.MemoryUsageBytes.HasValue ? 
                                        $"{HealthCheckData.PerformanceMetrics.MemoryUsageBytes.Value / 1024 / 1024:F2}MB" : "N/A")
                                </MudText>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 健康检查项目 -->
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">检查项目</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (HealthCheckData.HealthCheckItems.Any())
                        {
                            <MudStack>
                                @foreach (var item in HealthCheckData.HealthCheckItems)
                                {
                                    <MudPaper Class="pa-3 mb-2" Elevation="1">
                                        <div class="d-flex align-center justify-space-between">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@GetHealthStatusIcon(item.Status)" 
                                                       Color="@GetHealthStatusColor(item.Status)" 
                                                       Class="mr-2" />
                                                <div>
                                                    <MudText Typo="Typo.subtitle1">@item.Name</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@item.Details</MudText>
                                                </div>
                                            </div>
                                            <MudChip T="string" Color="@GetHealthStatusColor(item.Status)" Size="Size.Small">
                                                @item.Status.ToString()
                                            </MudChip>
                                        </div>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText Color="Color.Secondary">暂无检查项目</MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- 问题列表 -->
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">发现的问题</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (HealthCheckData.Issues.Any())
                        {
                            <MudStack>
                                @foreach (var issue in HealthCheckData.Issues)
                                {
                                    <MudPaper Class="pa-3 mb-2" Elevation="1">
                                        <div class="d-flex align-center justify-space-between">
                                            <div class="d-flex align-center">
                                                <MudIcon Icon="@GetIssueSeverityIcon(issue.Severity)" 
                                                       Color="@GetIssueSeverityColor(issue.Severity)" 
                                                       Class="mr-2" />
                                                <div>
                                                    <MudText Typo="Typo.subtitle1">@issue.Title</MudText>
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@issue.Description</MudText>
                                                </div>
                                            </div>
                                            <MudChip T="string" Color="@GetIssueSeverityColor(issue.Severity)" Size="Size.Small">
                                                @issue.Severity.ToString()
                                            </MudChip>
                                        </div>
                                    </MudPaper>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText Color="Color.Success">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                                未发现问题
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</div>

@code {
    /// <summary>
    /// 健康检查数据
    /// </summary>
    [Parameter] public ModuleSystemHealthCheck? HealthCheckData { get; set; }

    /// <summary>
    /// 获取健康状态图标
    /// </summary>
    /// <param name="status">健康状态</param>
    /// <returns>图标名称</returns>
    private string GetHealthStatusIcon(HealthStatus status) => status switch
    {
        HealthStatus.Healthy => Icons.Material.Filled.CheckCircle,
        HealthStatus.Warning => Icons.Material.Filled.Warning,
        HealthStatus.Unhealthy => Icons.Material.Filled.Error,
        HealthStatus.Critical => Icons.Material.Filled.Dangerous,
        _ => Icons.Material.Filled.HelpOutline
    };

    /// <summary>
    /// 获取健康状态颜色
    /// </summary>
    /// <param name="status">健康状态</param>
    /// <returns>颜色</returns>
    private Color GetHealthStatusColor(HealthStatus status) => status switch
    {
        HealthStatus.Healthy => Color.Success,
        HealthStatus.Warning => Color.Warning,
        HealthStatus.Unhealthy => Color.Error,
        HealthStatus.Critical => Color.Error,
        _ => Color.Default
    };

    /// <summary>
    /// 获取问题严重程度图标
    /// </summary>
    /// <param name="severity">严重程度</param>
    /// <returns>图标名称</returns>
    private string GetIssueSeverityIcon(IssueSeverity severity) => severity switch
    {
        IssueSeverity.Information => Icons.Material.Filled.Info,
        IssueSeverity.Low => Icons.Material.Filled.Warning,
        IssueSeverity.Medium => Icons.Material.Filled.PriorityHigh,
        IssueSeverity.High => Icons.Material.Filled.Error,
        IssueSeverity.Critical => Icons.Material.Filled.Dangerous,
        _ => Icons.Material.Filled.HelpOutline
    };

    /// <summary>
    /// 获取问题严重程度颜色
    /// </summary>
    /// <param name="severity">严重程度</param>
    /// <returns>颜色</returns>
    private Color GetIssueSeverityColor(IssueSeverity severity) => severity switch
    {
        IssueSeverity.Information => Color.Info,
        IssueSeverity.Low => Color.Warning,
        IssueSeverity.Medium => Color.Warning,
        IssueSeverity.High => Color.Error,
        IssueSeverity.Critical => Color.Error,
        _ => Color.Default
    };
} 