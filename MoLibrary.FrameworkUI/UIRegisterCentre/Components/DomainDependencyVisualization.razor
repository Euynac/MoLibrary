@using Microsoft.Extensions.DependencyInjection
@using MoLibrary.RegisterCentre.Interfaces
@using MoLibrary.RegisterCentre.Models
@using MoLibrary.FrameworkUI.UIRegisterCentre.Services
@using MoLibrary.FrameworkUI.UIRegisterCentre.Models
@using MoLibrary.Tool.MoResponse
@using Microsoft.JSInterop
@inject RegisterCentreService RegisterCentreService
@inject IServiceProvider ServiceProvider
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">子域依赖关系图</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudTooltip Text="刷新数据">
                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                               Color="Color.Primary"
                               OnClick="LoadDomainDataAsync"
                               Disabled="@_loading" />
            </MudTooltip>
            <MudTooltip Text="重置视图">
                <MudIconButton Icon="@Icons.Material.Filled.RestartAlt"
                               Color="Color.Secondary"
                               OnClick="ResetView"
                               Disabled="@_loading" />
            </MudTooltip>
            <MudTooltip Text="布局设置">
                <MudIconButton Icon="@Icons.Material.Filled.Dashboard"
                               Color="Color.Info"
                               OnClick="ToggleLayoutPanel" />
            </MudTooltip>
            <MudTooltip Text="筛选设置">
                <MudIconButton Icon="@Icons.Material.Filled.FilterAlt"
                               Color="Color.Tertiary"
                               OnClick="ToggleFilterPanel" />
            </MudTooltip>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        @if (_showLayoutPanel)
        {
            <DomainLayoutPanel CurrentLayout="_currentLayout"
                               ForceDistance="_forceDistance"
                               ForceStrength="_forceStrength"
                               CurrentLayoutChanged="OnLayoutChanged"
                               ForceDistanceChanged="OnForceDistanceChanged"
                               ForceStrengthChanged="OnForceStrengthChanged" />
        }
        
        @if (_showFilterPanel)
        {
            <DomainFilterPanel @bind-FilterText="_filterText"
                               @bind-SelectedDomains="_selectedDomainsFilter"
                               @bind-ShowOnlyWithServices="_showOnlyWithServices"
                               @bind-ShowOnlyWithDependencies="_showOnlyWithDependencies"
                               OnFiltersChanged="ApplyFilters"
                               AllDomains="_domains" />
        }

        <MudPaper Class="visualization-container" Style="position: relative; height: 500px; overflow: hidden;">
            @if (_loading)
            {
                <MudOverlay Visible="true" DarkBackground="false" Absolute="true">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                </MudOverlay>
            }
            <div id="domain-dependency-graph" style="width: 100%; height: 100%;"></div>
        </MudPaper>
        
        <MudPaper Class="mt-4 pa-2" Elevation="0" Outlined="true">
            <MudGrid AlignItems="Center">
                <MudItem xs="12" sm="8">
                    <MudText Typo="Typo.caption">
                        显示 @_filteredDomains.Count / @_domains.Count 个子域，@_filteredDependencies.Count / @_dependencies.Count 个依赖关系
                    </MudText>
                </MudItem>
                <MudItem xs="12" sm="4" Class="d-flex justify-end">
                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Circle" Color="Color.Info">节点：子域</MudChip>
                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Primary">箭头：依赖</MudChip>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public EventCallback<string> OnDomainClick { get; set; }
    
    private IJSObjectReference? _jsModule;
    private List<DomainInfo> _domains = [];
    private List<DomainInfo> _filteredDomains = [];
    private List<DomainDependency> _dependencies = [];
    private List<DomainDependency> _filteredDependencies = [];
    private Dictionary<string, string> _domainColors = new();
    private Dictionary<string, List<RegisteredServiceStatus>> _domainServicesMap = new();
    private bool _loading = false;
    
    // 筛选相关字段
    private bool _showFilterPanel = false;
    private bool _showLayoutPanel = false;
    private string _filterText = string.Empty;
    private IReadOnlyCollection<string> _selectedDomainsFilter = new HashSet<string>();
    private bool _showOnlyWithServices = false;
    private bool _showOnlyWithDependencies = false;
    
    // 布局相关字段
    private DomainLayoutType _currentLayout = DomainLayoutType.Force;
    private int _forceDistance = 200;
    private int _forceStrength = -800;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", 
                "./_content/MoLibrary.FrameworkUI/UIRegisterCentre/domainDependencyGraph.js");
            
            await InitializeGraph();
            await LoadDomainDataAsync();
        }
    }

    private async Task InitializeGraph()
    {
        if (_jsModule != null)
        {
            var isDarkMode = await JSRuntime.InvokeAsync<bool>("eval", 
                "document.documentElement.classList.contains('dark')");
            
            await _jsModule.InvokeVoidAsync("initializeGraph", "domain-dependency-graph", isDarkMode,
                DotNetObjectReference.Create(this));
        }
    }

    private async Task LoadDomainDataAsync()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // 使用RegisterCentreService获取域信息和颜色分配
            if (!(await RegisterCentreService.GetDomainsWithColorsAsync()).IsFailed(out var error, out var domains))
            {
                _domains = domains ?? [];

                // 获取颜色映射
                _domainColors = RegisterCentreService.GetAllDomainColors();

                // 获取合并的服务状态来构建依赖关系
                if (!(await RegisterCentreService.GetMergedServicesStatusAsync()).IsFailed(out var servicesError, out var services))
                {
                    BuildDomainDependencies(services ?? []);
                    BuildDomainServicesMap(services ?? []);
                }
                else
                {
                    Snackbar.Add($"获取服务状态失败: {servicesError.Message}", Severity.Warning);
                }

                // 初始化筛选
                InitializeFilters();
                
                // 应用筛选
                ApplyFilters();

                await UpdateGraph();
            }
            else
            {
                Snackbar.Add($"获取域信息失败: {error.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载域数据失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void BuildDomainDependencies(List<RegisteredServiceStatus> services)
    {
        _dependencies.Clear();
        var dependencySet = new HashSet<(string, string)>();

        foreach (var service in services)
        {
            if (service.DependentSubDomains?.Any() == true)
            {
                var sourceDomain = service.DomainName ?? "未知";
                
                foreach (var dependentDomain in service.DependentSubDomains)
                {
                    if (sourceDomain != dependentDomain && 
                        dependencySet.Add((sourceDomain, dependentDomain)))
                    {
                        _dependencies.Add(new DomainDependency
                        {
                            SourceDomain = sourceDomain,
                            TargetDomain = dependentDomain,
                            ServiceCount = services.Count(s => 
                                (s.DomainName ?? "未知") == sourceDomain && 
                                s.DependentSubDomains?.Contains(dependentDomain) == true)
                        });
                    }
                }
            }
        }
    }

    private void BuildDomainServicesMap(List<RegisteredServiceStatus> services)
    {
        _domainServicesMap.Clear();
        
        foreach (var service in services)
        {
            var domainName = service.DomainName ?? "未知";
            if (!_domainServicesMap.ContainsKey(domainName))
            {
                _domainServicesMap[domainName] = new List<RegisteredServiceStatus>();
            }
            _domainServicesMap[domainName].Add(service);
        }
    }

    [JSInvokable]
    public async Task OnDomainClickFromJS(string domainName)
    {
        if (OnDomainClick.HasDelegate)
        {
            await OnDomainClick.InvokeAsync(domainName);
        }
    }

    private void InitializeFilters()
    {
        // 初始化选择的域
        if (!_selectedDomainsFilter.Any())
        {
            var allDomainNames = _domains.Select(d => d.Name).ToList();
            _selectedDomainsFilter = new HashSet<string>(allDomainNames);
        }
    }
    
    private void ToggleFilterPanel()
    {
        _showFilterPanel = !_showFilterPanel;
        if (_showFilterPanel) _showLayoutPanel = false;
    }
    
    private void ToggleLayoutPanel()
    {
        _showLayoutPanel = !_showLayoutPanel;
        if (_showLayoutPanel) _showFilterPanel = false;
    }

    private async Task ApplyFilters()
    {
        _filteredDomains = _domains.Where(domain =>
        {
            // 域名筛选
            if (!_selectedDomainsFilter.Contains(domain.Name))
                return false;
                
            // 文本筛选
            if (!string.IsNullOrWhiteSpace(_filterText))
            {
                var matchesText = domain.Name.Contains(_filterText, StringComparison.OrdinalIgnoreCase) ||
                                  (!string.IsNullOrEmpty(domain.DisplayName) && domain.DisplayName.Contains(_filterText, StringComparison.OrdinalIgnoreCase)) ||
                                  (!string.IsNullOrEmpty(domain.Description) && domain.Description.Contains(_filterText, StringComparison.OrdinalIgnoreCase));
                
                if (!matchesText)
                    return false;
            }
            
            // 仅显示有服务的域
            if (_showOnlyWithServices)
            {
                var hasServices = _domainServicesMap.ContainsKey(domain.Name) && _domainServicesMap[domain.Name].Any();
                if (!hasServices)
                    return false;
            }
            
            return true;
        }).ToList();
        
        // 筛选依赖关系 - 只保留两端都在筛选后域列表中的依赖
        _filteredDependencies = _dependencies.Where(dep =>
        {
            var hasSource = _filteredDomains.Any(d => d.Name == dep.SourceDomain);
            var hasTarget = _filteredDomains.Any(d => d.Name == dep.TargetDomain);
            
            // 如果仅显示有依赖的域，则需要确保依赖关系两端都存在
            if (_showOnlyWithDependencies)
            {
                return hasSource && hasTarget;
            }
            
            return hasSource && hasTarget;
        }).ToList();
        
        // 如果仅显示有依赖的域，进一步过滤域列表
        if (_showOnlyWithDependencies)
        {
            var domainsWithDependencies = new HashSet<string>();
            foreach (var dep in _filteredDependencies)
            {
                domainsWithDependencies.Add(dep.SourceDomain);
                domainsWithDependencies.Add(dep.TargetDomain);
            }
            
            _filteredDomains = _filteredDomains.Where(d => domainsWithDependencies.Contains(d.Name)).ToList();
        }
        
        await UpdateGraph();
    }

    private async Task UpdateGraph()
    {
        if (_jsModule != null)
        {
            var graphData = PrepareGraphData();
            await _jsModule.InvokeVoidAsync("updateGraph", graphData);
            
            // 应用当前布局设置
            await SetLayout(_currentLayout);
            if (_currentLayout == DomainLayoutType.Force)
            {
                await _jsModule.InvokeVoidAsync("setForceDistance", _forceDistance);
                await _jsModule.InvokeVoidAsync("setForceStrength", _forceStrength);
            }
        }
    }
    
    private async Task SetLayout(DomainLayoutType layoutType)
    {
        _currentLayout = layoutType;
        if (_jsModule != null)
        {
            var layoutName = layoutType switch
            {
                DomainLayoutType.Force => "force",
                DomainLayoutType.Hierarchy => "hierarchy",
                DomainLayoutType.Circular => "circular",
                DomainLayoutType.RadialTree => "radial_tree",
                _ => "force"
            };
            await _jsModule.InvokeVoidAsync("setLayout", layoutName);
        }
    }
    
    private async Task OnLayoutChanged(DomainLayoutType layoutType)
    {
        await SetLayout(layoutType);
    }
    
    private async Task OnForceDistanceChanged(int value)
    {
        _forceDistance = value;
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("setForceDistance", value);
        }
    }
    
    private async Task OnForceStrengthChanged(int value)
    {
        _forceStrength = value;
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("setForceStrength", value);
        }
    }

    private object PrepareGraphData()
    {
        var nodes = _filteredDomains.Select(domain => new
        {
            id = domain.Name,
            name = domain.DisplayName ?? domain.Name,
            description = domain.Description,
            color = RegisterCentreService.GetDomainColor(domain.Name),
            services = _domainServicesMap.GetValueOrDefault(domain.Name, new List<RegisteredServiceStatus>())
                .Select(s => new
                {
                    name = s.AppName,
                    appName = s.AppName,
                    status = s.OverallStatus.ToString(),
                    overallStatus = s.OverallStatus.ToString()
                }).ToList()
        }).ToList();

        var links = _filteredDependencies.Select(dep => new
        {
            source = dep.SourceDomain,
            target = dep.TargetDomain,
            serviceCount = dep.ServiceCount,
            color = RegisterCentreService.GetDomainColor(dep.SourceDomain)
        }).ToList();

        return new { nodes, links };
    }

    private async Task ResetView()
    {
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("resetView");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("dispose");
            await _jsModule.DisposeAsync();
        }
    }

    private class DomainDependency
    {
        public required string SourceDomain { get; set; }
        public required string TargetDomain { get; set; }
        public int ServiceCount { get; set; }
    }
}