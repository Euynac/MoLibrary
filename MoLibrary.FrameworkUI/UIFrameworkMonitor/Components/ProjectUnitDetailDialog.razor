@using MoLibrary.Framework.Core.Model
@using System.Linq
@using System.Reflection

<MudDialog @bind-Visible="Visible" Options="DialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-3" />
            项目单元详情
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (SelectedUnit != null)
        {
            <MudSimpleTable Style="overflow-x: auto;" Elevation="0">
                <tbody>
                    <tr>
                        <td style="min-width: 120px;"><MudText Typo="Typo.subtitle2">单元名称</MudText></td>
                        <td><MudText>@SelectedUnit.Title</MudText></td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.subtitle2">完整名称</MudText></td>
                        <td><MudText>@SelectedUnit.Key</MudText></td>
                    </tr>
                    @if (!string.IsNullOrEmpty(SelectedUnit.Author))
                    {
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">作者</MudText></td>
                            <td><MudText>@SelectedUnit.Author</MudText></td>
                        </tr>
                    }
                    @if (SelectedUnit.Group?.Any() == true)
                    {
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">分组</MudText></td>
                            <td><MudText>@string.Join(", ", SelectedUnit.Group)</MudText></td>
                        </tr>
                    }
                    @if (!string.IsNullOrEmpty(SelectedUnit.Description))
                    {
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">描述</MudText></td>
                            <td><MudText>@SelectedUnit.Description</MudText></td>
                        </tr>
                    }
                    <tr>
                        <td><MudText Typo="Typo.subtitle2">单元类型</MudText></td>
                        <td>
                            <MudChip T="string" Size="Size.Small" 
                                     Style="@($"background-color: {GetUnitTypeColor(SelectedUnit.UnitType)}; color: white;")">
                                @SelectedUnit.UnitType.ToString()
                            </MudChip>
                        </td>
                    </tr>
                    <tr>
                        <td><MudText Typo="Typo.subtitle2">统计信息</MudText></td>
                        <td>
                            <MudChipSet T="string">
                                @if (SelectedUnit.DependencyUnits.Count > 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" 
                                             Icon="@Icons.Material.Filled.Link">
                                        依赖 @SelectedUnit.DependencyUnits.Count
                                    </MudChip>
                                }
                                @if (SelectedUnit.DependedByCount > 0)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success"
                                             Icon="@Icons.Material.Filled.CallReceived">
                                        被依赖 @SelectedUnit.DependedByCount
                                    </MudChip>
                                }
                                @if (SelectedUnit.Attributes.Any())
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Secondary"
                                             Icon="@Icons.Material.Filled.Label">
                                        特性 @SelectedUnit.Attributes.Count
                                    </MudChip>
                                }
                                @if (SelectedUnit.Methods.Any())
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary"
                                             Icon="@Icons.Material.Filled.Functions">
                                        方法 @SelectedUnit.Methods.Count
                                    </MudChip>
                                }
                                @if (SelectedUnit.Alerts.Any())
                                {
                                    var errorCount = SelectedUnit.Alerts.Count(a => a.Level == EAlertLevel.Error);
                                    var warningCount = SelectedUnit.Alerts.Count(a => a.Level == EAlertLevel.Warning);
                                    var infoCount = SelectedUnit.Alerts.Count(a => a.Level == EAlertLevel.Info);
                                    
                                    @if (errorCount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error"
                                                 Icon="@Icons.Material.Filled.Error">
                                            错误 @errorCount
                                        </MudChip>
                                    }
                                    @if (warningCount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning"
                                                 Icon="@Icons.Material.Filled.Warning">
                                            警告 @warningCount
                                        </MudChip>
                                    }
                                    @if (infoCount > 0)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info"
                                                 Icon="@Icons.Material.Filled.Info">
                                            信息 @infoCount
                                        </MudChip>
                                    }
                                }
                            </MudChipSet>
                        </td>
                    </tr>
                    @if (SelectedUnit.DependencyUnits.Any())
                    {
                        <tr>
                            <td style="vertical-align: top;"><MudText Typo="Typo.subtitle2">依赖单元</MudText></td>
                            <td>
                                <MudChipSet T="string">
                                    @foreach (var dep in SelectedUnit.DependencyUnits)
                                    {
                                        <MudChip T="string" Size="Size.Small" 
                                                 Style="@($"background-color: {GetUnitTypeColor(dep.UnitType)}; color: white;")"
                                                 OnClick="@(() => OnChipClick(dep.Key))">
                                            @dep.Title
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </td>
                        </tr>
                    }
                    @if (DependedByUnits != null && DependedByUnits.Any())
                    {
                        <tr>
                            <td style="vertical-align: top;"><MudText Typo="Typo.subtitle2">被依赖单元</MudText></td>
                            <td>
                                <MudChipSet T="string">
                                    @foreach (var dep in DependedByUnits)
                                    {
                                        <MudChip T="string" Size="Size.Small"
                                                 Style="@($"background-color: {GetUnitTypeColor(dep.UnitType)}; color: white;")"
                                                 OnClick="@(() => OnChipClick(dep.Key))">
                                            @dep.Title
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </td>
                        </tr>
                    }
                    @if (SelectedUnit.Attributes.Any())
                    {
                        <tr>
                            <td style="vertical-align: top;"><MudText Typo="Typo.subtitle2">特性</MudText></td>
                            <td>
                                <MudChipSet T="string">
                                    @foreach (var attr in SelectedUnit.Attributes)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">
                                            @attr.GetType().Name
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </td>
                        </tr>
                    }
                    @if (SelectedUnit.Methods.Any())
                    {
                        <tr>
                            <td style="vertical-align: top;"><MudText Typo="Typo.subtitle2">方法信息</MudText></td>
                            <td>
                                <MudExpansionPanels>
                                    <MudExpansionPanel>
                                        <TitleContent>
                                            <div style="display: flex; align-items: center">
                                                <MudIcon Icon="@Icons.Material.Filled.Functions" class="mr-3" />
                                                <MudText>公共方法 (@SelectedUnit.Methods.Count)</MudText>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            <MudStack Spacing="2">
                                                @foreach (var method in SelectedUnit.Methods)
                                                {
                                                    <MudCard Outlined="true" Style="border-left: 3px solid var(--mud-palette-primary);">
                                                        <MudCardContent Class="pa-2">
                                                            <div class="d-flex align-center justify-space-between">
                                                                <MudText Typo="Typo.caption" Style="font-family: 'Cascadia Code', 'JetBrains Mono', monospace; background-color: var(--mud-palette-background-grey); padding: 6px 10px; border-radius: 4px; flex-grow: 1;">
                                                                    @method.MethodSignature
                                                                </MudText>
                                                                <MudChipSet T="string" Class="ml-2">
                                                                    @if (method.MethodInfo.IsStatic)
                                                                    {
                                                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary" 
                                                                                 Icon="@Icons.Material.Filled.Public">
                                                                            Static
                                                                        </MudChip>
                                                                    }
                                                                    @if (method.MethodInfo.IsVirtual && !method.MethodInfo.IsAbstract)
                                                                    {
                                                                        <MudChip T="string" Size="Size.Small" Color="Color.Tertiary">
                                                                            Virtual
                                                                        </MudChip>
                                                                    }
                                                                    @if (method.MethodInfo.IsAbstract)
                                                                    {
                                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                                                            Abstract
                                                                        </MudChip>
                                                                    }
                                                                    @if (IsAsyncMethod(method.MethodInfo))
                                                                    {
                                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" 
                                                                                 Icon="@Icons.Material.Filled.Sync">
                                                                            Async
                                                                        </MudChip>
                                                                    }
                                                                </MudChipSet>
                                                            </div>
                                                            
                                                            @if (!string.IsNullOrEmpty(method.Description))
                                                            {
                                                                <MudText Typo="Typo.body2" Class="mt-2 ml-2" Style="color: var(--mud-palette-text-secondary); font-style: italic;">
                                                                    // @method.Description
                                                                </MudText>
                                                            }
                                                        </MudCardContent>
                                                    </MudCard>
                                                }
                                            </MudStack>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            </td>
                        </tr>
                    }
                    @if (SelectedUnit.Alerts.Any())
                    {
                        <tr>
                            <td style="vertical-align: top;"><MudText Typo="Typo.subtitle2">告警信息</MudText></td>
                            <td>
                                <MudStack Spacing="1">
                                    @foreach (var alert in SelectedUnit.Alerts.OrderByDescending(a => a.Level))
                                    {
                                        var alertColor = alert.Level switch
                                        {
                                            EAlertLevel.Error => Color.Error,
                                            EAlertLevel.Warning => Color.Warning,
                                            EAlertLevel.Info => Color.Info,
                                            _ => Color.Default
                                        };
                                        var alertIcon = alert.Level switch
                                        {
                                            EAlertLevel.Error => Icons.Material.Filled.Error,
                                            EAlertLevel.Warning => Icons.Material.Filled.Warning,
                                            EAlertLevel.Info => Icons.Material.Filled.Info,
                                            _ => Icons.Material.Filled.Info
                                        };
                                        <div class="d-flex align-center">
                                            <MudIcon Icon="@alertIcon" Color="@alertColor" Size="Size.Small" Class="mr-2" />
                                            <MudText>
                                                <strong>[@alert.Level]</strong> @alert.Message
                                                @if (!string.IsNullOrEmpty(alert.Source))
                                                {
                                                    <MudText Typo="Typo.caption" Class="ml-2" Style="display: inline;">(@alert.Source)</MudText>
                                                }
                                            </MudText>
                                        </div>
                                    }
                                </MudStack>
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">关闭</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public EventCallback<bool> VisibleChanged { get; set; }
    
    [Parameter] public DtoProjectUnit? SelectedUnit { get; set; }
    [Parameter] public List<DtoProjectUnit>? AllProjectUnits { get; set; }
    [Parameter] public EventCallback<string> OnNodeFocus { get; set; }
    
    private List<DtoProjectUnit>? DependedByUnits { get; set; }
    
    private readonly DialogOptions DialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };
    
    protected override void OnParametersSet()
    {
        if (SelectedUnit != null && AllProjectUnits != null)
        {
            // 计算被依赖的单元（哪些单元依赖了当前单元）
            DependedByUnits = AllProjectUnits
                .Where(u => u.DependencyUnits.Any(d => d.Key == SelectedUnit.Key))
                .ToList();
        }
    }
    
    private async Task OnChipClick(string nodeKey)
    {
        // 关闭对话框
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
        
        // 触发聚焦事件
        if (OnNodeFocus.HasDelegate)
        {
            await OnNodeFocus.InvokeAsync(nodeKey);
        }
    }
    
    private async Task Close()
    {
        Visible = false;
        await VisibleChanged.InvokeAsync(false);
    }
    
    private string GetUnitTypeColor(EProjectUnitType unitType)
    {
        return ProjectUnitVisualizationConfig.GetUnitTypeColor(unitType);
    }
    
    private bool IsAsyncMethod(MethodInfo method)
    {
        return method.ReturnType.IsGenericType && 
               (method.ReturnType.GetGenericTypeDefinition() == typeof(Task<>) || 
                method.ReturnType == typeof(Task));
    }
}