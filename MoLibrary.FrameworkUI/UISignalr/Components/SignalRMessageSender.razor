@using MudBlazor
@using Microsoft.AspNetCore.Components.Web

<!-- 快速消息发送 -->
<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h5" Class="mb-3">快速消息发送</MudText>
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudTextField Value="@UserName"
                        ValueChanged="@((string value) => OnUserNameChangedInternal(value))"
                        Label="用户名" 
                        Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudTextField Value="@Message"
                        ValueChanged="@((string value) => OnMessageChangedInternal(value))"
                        Label="消息内容" 
                        Variant="Variant.Outlined"
                        OnKeyDown="OnMessageKeyDown" />
        </MudItem>
        <MudItem xs="12">
            <MudStack Row Spacing="2">
                <MudButton Variant="Variant.Filled" 
                         Color="Color.Success" 
                         OnClick="SendMessageAsync"
                         Disabled="!IsConnected || string.IsNullOrWhiteSpace(Message)">
                    <MudIcon Icon="@Icons.Material.Filled.Send" />
                    <MudText Class="ms-2">发送消息</MudText>
                </MudButton>
                <MudButton Variant="Variant.Outlined" 
                         Color="Color.Secondary" 
                         OnClick="ClearMessageAsync"
                         Disabled="string.IsNullOrWhiteSpace(Message)">
                    <MudIcon Icon="@Icons.Material.Filled.Clear" />
                    <MudText Class="ms-2">清空</MudText>
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    /// <summary>
    /// 用户名
    /// </summary>
    [Parameter] public string UserName { get; set; } = "";

    /// <summary>
    /// 用户名变化回调
    /// </summary>
    [Parameter] public EventCallback<string> UserNameChanged { get; set; }

    /// <summary>
    /// 消息内容
    /// </summary>
    [Parameter] public string Message { get; set; } = "";

    /// <summary>
    /// 消息内容变化回调
    /// </summary>
    [Parameter] public EventCallback<string> MessageChanged { get; set; }

    /// <summary>
    /// 是否已连接
    /// </summary>
    [Parameter] public bool IsConnected { get; set; }

    /// <summary>
    /// 发送消息回调
    /// </summary>
    [Parameter] public EventCallback<(string userName, string message)> OnSendMessage { get; set; }

    /// <summary>
    /// 消息输入框键盘事件
    /// </summary>
    /// <param name="e">键盘事件参数</param>
    private async Task OnMessageKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessageAsync();
        }
    }

    /// <summary>
    /// 发送消息
    /// </summary>
    private async Task SendMessageAsync()
    {
        if (!IsConnected || string.IsNullOrWhiteSpace(Message))
            return;

        await OnSendMessage.InvokeAsync((UserName, Message));
        
        // 发送成功后不清空输入框，保持用户输入的内容
        // 如果用户需要清空，可以点击"清空"按钮
    }

    /// <summary>
    /// 清空消息输入框
    /// </summary>
    private async Task ClearMessageAsync()
    {
        Message = "";
        await MessageChanged.InvokeAsync(Message);
        StateHasChanged();
    }

    private void OnUserNameChangedInternal(string value)
    {
        UserName = value;
        UserNameChanged.InvokeAsync(value);
    }

    private void OnMessageChangedInternal(string value)
    {
        Message = value;
        MessageChanged.InvokeAsync(value);
    }
}